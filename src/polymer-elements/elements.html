<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/font-roboto/roboto.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/helpers/helpers.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-from-bottom-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-down-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">

<dom-module id="event-app">
    <template>
        <app-location route="{{route}}"></app-location>
        <app-route
            route="{{route}}"
            pattern="/:page"
            data="{{routeData}}"
            tail="{{subroute}}">
        </app-route>
        <app-drawer-layout fullbleed>
            <!-- Drawer toggle for smaller screens -->
            <app-drawer id="drawer">
                <app-toolbar>Menu</app-toolbar>
                <paper-menu selected="[[page]]" attr-for-selected="name" role="navigation">
                    <paper-item name="signin" hidden$="[[signedIn]]">
                        <a class="item" href="/signin/">Sign In</a>
                    </paper-item>
                    <paper-item name="signup" hidden$="[[signedIn]]">
                        <a class="item" href="/signup/">Sign Up</a>
                    </paper-item>
                    <paper-item name="events">
                        <a class="item" href="/events/" hidden$="[[!signedIn]]">Events</a>
                    </paper-item>
                    <paper-item name="user" hidden$="[[!signedIn]]">
                        <a class="item" href="/user/">Me</a>
                    </paper-item>
                    <paper-item name="logout" hidden$="[[!signedIn]]">
                        <a class="item" on-tap="logout">Logout</a>
                    </paper-item>
                </paper-menu>
            </app-drawer>
            <!-- Main content  -->
            <app-header-layout>
                <app-header condenses reveals shadow threshold="1">
                    <app-toolbar class="header-theme">
                        <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
                        <div class="title" style="position: relative">
                          <a href="/">{{title}}>
                              <img src="image/logo.png" alt="" class="my-logo">
                          </a>
                        </div>
                        <iron-selector selected="[[page]]" attr-for-selected="name" hidden$="{{!wideLayout}}">
                          <a class="navlink" name="signin" href="/signin/" hidden$="[[signedIn]]">Sign In</a>
                          <a class="navlink" name="signup" href="/signup/" hidden$="[[signedIn]]">Sign Up</a>
                          <a class="navlink" name="events" href="/events/" hidden$="[[!signedIn]]">Events</a>
                          <a class="navlink" name="user" href="/user/" hidden$="[[!signedIn]]">Me</a>
                          <a class="navlink" on-tap="logout" href="/" hidden$="[[!signedIn]]">Logout</a>
                        </iron-selector>
                    </app-toolbar>
                </app-header>
                <!-- Main views, visible depending on the current route -->
                <neon-animated-pages
                  selected="[[page]]"
                  attr-for-selected="name"
                  entry-animation="slide-from-bottom-animation"
                  exit-animation="slide-down-animation">
                  <meetup-home name="home"></meetup-home>
                  <meetup-events name="events"></meetup-events>
                  <meetup-signin id="signinPage" name="signin" on-sign-in="signIn" page="[[page]]"></meetup-signin>
                  <meetup-signup name="signup" on-sign-up="signUp" page="[[page]]"></meetup-signup>
                  <meetup-user name="user" user="[[user]]"></meetup-user>
                </neon-animated-pages>
            </app-header-layout>
        </app-drawer-layout>
        <iron-media-query query="min-width: 600px" query-matches="{{wideLayout}}"></iron-media-query>
    </template>
    <script>

    Polymer({

      is: 'event-app',

      behaviors: [
        Polymer.NeonAnimationRunnerBehavior
      ],

      properties: {
        entryAnimation: {
          value: 'fade-in-animation'
        },
        title: {
          type: String,
          value: 'Coimbatore\'s Event!'
        },
        wideLayout: {
          type: Boolean,
          value: false,
          observer: '_onLayoutChange',
        },
        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        }
      },

      ready: function() {
        this.style.visibility = 'visible';
        this.playAnimation('entry');
      },

      observers: [
        '_routePathChanged(routeData.page)',
        '_signedInChanged(signedIn)'
      ],

      _routePathChanged: function(page) {
        // Check for authorized user, preventing users not signed in from accessing the "user" or "events" views
        if (!this.signedIn) {
          if (page === 'user' || page === 'events') {
            this.set('routeData.page', 'signin');
          }
          else {
            this.page = page || 'home';
          }
        }
        // Set default view
        else {
          this.page = page || 'home';
        }
        // when changing routes, have views scroll to top of page
        Polymer.AppLayout.scroll({top: 0, behavior: 'smooth'});
      },

      _signedInChanged: function(signedIn) {
        if (signedIn === true) {
          this.set('routeData.page', 'events');
        }
        else if (signedIn === false) {
          this.set('routeData.page', '');
        }
      },

      _onLayoutChange: function(wide) {
        var drawer = this.$.drawer;

        if (wide && drawer.opened) {
          drawer.opened = false;
        }
      },

      // Lazy-load observer. When routeData.page changes, import the new view
      _pageChanged: function(page, oldPage) {
        if (page) {
          this.importHref(
            this.resolveUrl('meetup-' + page + '.html'), null, null, true);
          this.$.drawer.opened = false;
        }
      },

      // Firebase promise to create user.
      signUp: function(e) {
        var self = this;
        this.$.auth.createUserWithEmailAndPassword(e.detail.email, e.detail.password)
          .then(function(data) {
            // setTimeout "hack" to allow enough time for user to be created before saving user info to the database. Without setTimeout, the data would be saved to the database without a unique user ID.
            setTimeout(function() {
              self.userInfo = {
                firstname: e.detail.firstname,
                lastname: e.detail.lastname,
                job: e.detail.job,
                image: e.detail.image
              };
              return self.$.userStuff.setStoredValue(self.$.userStuff.path, self.userInfo)
                .then(function(data) {
                  console.log(self.userInfo);
                });
            }, 1000);
          });
      },

      // On success or error of signing in, set the error boolean appropriately. signInError determines whether or not to display the error message.
      signIn: function(e) {
        var self = this;
        this.$.auth.signInWithEmailAndPassword(e.detail.email, e.detail.password).then(function(data) {
          if (data) {
            self.$.signinPage.signInError = false;
          }
        }, function(error) {
          self.$.signinPage.signInError = true;
          self.$.signinPage.errorMessage = error.message || 'Invalid email or password.';
        });
      },

      logout: function() {
        var self = this;
        if (this.$.auth) {
          this.$.auth.signOut();
        }
      }
    });

    </script>
</dom-module>